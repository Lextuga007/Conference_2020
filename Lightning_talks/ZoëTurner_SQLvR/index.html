<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Why do I need to learn R when I can use SQL?</title>
    <meta charset="utf-8" />
    <meta name="author" content="Zoë Turner, Senior Information Analyst" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/panelset-0.2.4/panelset.css" rel="stylesheet" />
    <script src="libs/panelset-0.2.4/panelset.js"></script>
    <script src="libs/clipboard-2.0.6/clipboard.min.js"></script>
    <link href="libs/xaringanExtra-clipboard-0.2.4/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-clipboard-0.2.4/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"Copy Code","success":"Copied!","error":"Press Ctrl+C to Copy"})</script>
    <link href="libs/font-awesome-5.3.1/css/fontawesome-all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/nhsr.css" type="text/css" />
    <link rel="stylesheet" href="css/nhsr-fonts.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">




name: hello
class: title-slide, right, bottom

# Why do I need to learn R when I can use SQL?
----
## Zoë Turner, Senior Information Analyst
## November 2020

---

### Why a talk on this?

.pull-left[

 &lt;img src="https://media.giphy.com/media/L0lW0pxa3HbD128xO9/giphy.gif" height="450px" /&gt;

]

.pull-right[

* Analysts in the NHS and Local Authorities use SQL and Excel for their analysis.

* 'I can do everything I learned in the introduction course in SQL. Why do I need R?'

* Really, what's all the fuss about?
]


---

### SQL SPC

.left-col[.center[
&lt;video width="640" height="470" controls&gt;
  &lt;source src="videos/SPC_SQL_code_words.mp4" type="video/mp4"&gt;
&lt;/video&gt;
]]

.footnote[SPC = Statistical Process Control]
---

background-image: url("https://media.giphy.com/media/KZNGTvSbtlHR90BpyM/giphy.gif")
background-position: center
background-size: contain

---


### A better way is to...


.pull-left[Use a package like [qicharts2](https://cran.r-project.org/web/packages/qicharts2/index.html) from CRAN (or [runcharter](https://github.com/johnmackintosh/runcharter) or [spcccharter](https://github.com/johnmackintosh/spccharter) by @_johnmackintosh and code can be as small as this...


```r
qic(month, n, days,
    data     = hospital_infections,
*   facets   = infection ~ hospital,
    chart    = 'u',
    multiply = 10000,
    scales   = 'free_y',
    x.angle  = 45,
    title    = 'Hospital acquired infections in the Capital Region of Denmark',
    ylab     = 'Cases per 10,000 risk days',
    xlab     = 'Month')
```
]

--

.pull-right[...creating multiple charts in one go 
![](SQLRTalk_files/figure-html/unnamed-chunk-1-1.png)&lt;!-- --&gt;
]


---
class: middle, center

## But this isn't about charts, this is about code...

So let's compare R and SQL coding to create dummy/fake data

---

### SQL 

.pull-left[

 &lt;img src="images/sqlFillDown.PNG" height="450px" /&gt;
 ]

.pull-right[

* 76 lines of code

* I may have many years' experience but I spent several hours learning to produce fake data

* this requires a server to run, even when using dummy data

]

---

### And now in R

.pull-left[

![](images/rInSQLForComparison.PNG)

]

.pull-right[

* 25 lines of code

* I have 2 years' experience and took less than an hour to produce fake data

* This only requires R/RStudio (free software) and existing hardware (my laptop)
]

---


### Filling down 

Imagine you have some data and you want to [fill the empty cells with previous row value](https://stackoverflow.com/questions/3465847/sql-how-to-fill-empty-cells-with-previous-row-value): 

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; Dates &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Customer &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Value &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 20100101 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 12 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 20100102 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 20100101 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 20100102 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 20100101 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 32 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 20100102 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 39 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 20100101 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 42 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 20100102 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 20100101 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 15 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 20100102 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 16 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

### SQL code requires CTE
&lt;br/&gt;

... roughly 34 lines of SQL code

&lt;img src="images/sqlFillScreenshot.PNG" height="390px"/&gt;

.footnote[CTE = Common Text Expression]

---

### R code 
&lt;br/&gt;

.pull-left[
In contrast, R only take 1 line of code 


```r
example %&gt;% 
  fill(Rule, .direction = 'down')
```
]
.pull-right[
leaving lots of space for a GIF

![](https://media.giphy.com/media/xT8qBhrlNooHBYR9f2/giphy.gif)
]
---

### Still not convinced...

.pull-left[
&lt;img src="https://media.giphy.com/media/yj5oYHjoIwv28/giphy.gif" width="90%"/&gt;
]

.pull-right[
**Let's see if I can convince you with...**

]

---

### Two words...

--

![](https://media.giphy.com/media/dwpbGUm18BAfm/giphy.gif)

.pull-right[

# Pivot Tables

]

---

### Pivoting 

.panelset[
.panel[.panel-name[Long to Wide data]

.pull-left[
Let's take a small long data set like this...

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; Patient &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; System &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; DateofBirth_sk &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; S1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19680103 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; RIO &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19680103 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; IAPT &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19680103 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; S1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19970509 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 4 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; RIO &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19471209 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 5 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; S1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19660321 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 6 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; IAPT &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19780131 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]
.pull-right[
and turn it into this wide...



&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; Patient &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; S1 &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; RIO &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; IAPT &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]
] &lt;!--end--&gt;

.panel[.panel-name[SQL operators]
.green[Hard coded]


```r
SELECT *
FROM 
(
  SELECT Patient, Service, DateofBirth_sk
  FROM #patients
) AS src
PIVOT
(
  COUNT(DateofBirth_sk)
  FOR Service IN ([S1], [RIO], [IAPT])
) AS pivt;
```
] &lt;!--end--&gt;

.panel[.panel-name[SQL Joins]
.green[Code is verbose]


```r
SELECT p.Patient
,CASE WHEN S1.Patient IS NULL THEN 0 ELSE 1 END AS S1
,CASE WHEN rio.Patient IS NULL THEN 0 ELSE 1 END AS RIO
,CASE WHEN iapt.Patient IS NULL THEN 0 ELSE 1 END AS IAPT
FROM #patients AS p
LEFT JOIN (SELECT Patient
			,Service
			FROM #patients
			WHERE Service = 'S1') AS S1 ON S1.Patient = p.Patient
LEFT JOIN (SELECT Patient
			,Service
			FROM #patients
			WHERE Service = 'RIO') AS rio ON rio.Patient = p.Patient
GROUP BY p.Patient
,CASE WHEN S1.Patient IS NULL THEN 0 ELSE 1 END
,CASE WHEN rio.Patient IS NULL THEN 0 ELSE 1 END
```
] &lt;!--end--&gt;

.panel[.panel-name[SQL CASE WHEN]
.green[Flexible and concise]

```r
SELECT Patient
,DateofBirth_sk
,S1				    = MAX(CASE WHEN Service = 'S1' THEN 1 ELSE 0 END)
,Rio					= MAX(CASE WHEN Service = 'RIO' THEN 1 ELSE 0 END)
,IAPT					= MAX(CASE WHEN Service = 'IAPT' THEN 1 ELSE 0 END)
FROM #patients
GROUP BY Patient
,DateofBirth_sk
ORDER BY Patient
```
] &lt;!--end--&gt;

.panel[.panel-name[R code]
.green[About the same amount of code in this example but many more services could be added with no need for more coding.]


```r
library(tidyr)

wideData &lt;- examplePivot %&gt;% 
  mutate(value = 1) %&gt;%
  select(-DateofBirth_sk) %&gt;% 
  pivot_wider(names_from = System,
              values_from = value, 
              values_fill = 0)
```

] &lt;!--end--&gt;

.panel[.panel-name[R code - cont]
.green[It's also possible to move data from wide to long and repeat this within the same amount of code... as many times as required]


```r
library(tidyr)

examplePivot %&gt;% 
  mutate(value = 1) %&gt;%
  select(-DateofBirth_sk) %&gt;% 
  pivot_wider(names_from = System,
              values_from = value,
              values_fill = 0) %&gt;% 
  pivot_longer(cols = -Patient,
               names_to = "service",
               values_to = "values")
```

] &lt;!--end--&gt;
] &lt;!--end of panelset--&gt;

---

### Dummy Data

.panelset[
.panel[.panel-name[SQL Dummy Data]
.green[Based on real life example of having multiple databases]


```r
CREATE TABLE #patients (
   Patient integer,
     Service varchar(5),
	 DateofBirth_sk int
);
INSERT  INTO #Patients
    VALUES  (1, 'S1', 19680103),
			(1, 'RIO', 19680103),
			(1, 'IAPT', 19680103),
			(3, 'S1', 19970509),
			(4, 'RIO', 19471209),
			(5, 'S1', 19660321),
			(6, 'IAPT', 19780131)
```
] &lt;!--end--&gt;

.panel[.panel-name[R Dummy Data]
.green[Based on real life example of having multiple databases]


```r
examplePivot &lt;- tibble::tribble(
   ~Patient, ~System, ~DateofBirth_sk,
  1, 'S1', 19680103,
  1, 'RIO', 19680103,
  1, 'IAPT', 19680103,
  3, 'S1', 19970509,
  4, 'RIO', 19471209,
  5, 'S1', 19660321,
  6, 'IAPT', 19780131)

examplePivot %&gt;% 
  knitr::kable(format = "html")
```
] &lt;!--end--&gt;
] &lt;!--end of panelset--&gt;
---
name: goodbye
class: middle, inverse

# **Thank you!**
&lt;br/&gt;

Acknowledgements: the professional look of this presentation, using NHS and Nottinghamshire Healthcare NHS Foundation Trust colour branding, exists because of the amazing work of Silvia Canelón, details of the workshops she ran at the [NHS-R Community conference](https://spcanelon.github.io/xaringan-basics-and-beyond/index.html).

Thanks too to Simon Wellesley-Miller who ran an [R Markdown workshop](https://github.com/SimonW-M/Markdown) at the conference, where I finally found out how to get GIFs into my slides.

.warmyellow[It goes without saying that SQL can't produce presentations.]

[<i class="fab  fa-twitter "></i> @Letxuga007](https://twitter.com/Letxuga007)&lt;br/&gt;
[<i class="fab  fa-github "></i> @Lextuga007](https://github.com/Lextuga007)&lt;br/&gt;
[<i class="fas  fa-paper-plane "></i> zoe.turner2@notthshc.nhs.uk](mailto:zoe.turner2@nottshc.nhs.uk)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "googlecode",
"highlightLines": true,
"highlightLanguage": "r",
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>
<!--Hat-tip: https://www.garrickadenbuie.com/blog/xaringan-tip-logo-all-slides/-->
<style>
.logo {
  background-image: url(img/nottshc.png);
  background-size: contain;
  background-repeat: no-repeat;
  position: absolute;
  top: 2.5em;
  right: 1em;
  width: 250px;
  height: 150px;
  z-index: 0;
}

</style>

<script>
document
  .querySelectorAll(
    '.remark-slide-content' +
    ':not(.title-slide)' +
    // add additional classes to exclude here, e.g.
    ':not(.inverse)' +
    ':not(.hide-logo)' 
  )
  .forEach(el => {
    el.innerHTML += '<div class="logo"></div>';
  });
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
